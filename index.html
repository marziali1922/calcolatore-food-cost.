<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Cost Manager Pro</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome per le icone -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" xintegrity="sha512-Fo3rlrZj/k7p7x1c3/6Q6t+uH0T6x/2j2F0+z6ZgL9e8K+6t2gK6j9OaVp/zE2oY8u9E0rD4lM4q/g6WjQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f0f4f8, #e6e9f0);
        }
        .message-box {
            animation: fadeInOut 5s forwards;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-10px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }
    </style>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let userId;

        // --- DOM Elements ---
        const messageBox = document.getElementById('message-box');
        const ingredientsForm = document.getElementById('ingredients-form');
        const ingredientsList = document.getElementById('ingredients-list');
        const recipesForm = document.getElementById('recipes-form');
        const recipesList = document.getElementById('recipes-list');
        const addRecipeIngredientButton = document.getElementById('add-recipe-ingredient-btn');
        const ingredientsContainer = document.getElementById('recipe-ingredients-container');
        const userIdDisplay = document.getElementById('user-id-display');
        const modal = document.getElementById('edit-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const editForm = document.getElementById('edit-form');
        const editNameInput = document.getElementById('edit-name');
        const editCostInput = document.getElementById('edit-cost');
        const editUnitInput = document.getElementById('edit-unit');
        const saveEditButton = document.getElementById('save-edit-btn');
        const currentRecipeCostDisplay = document.getElementById('current-recipe-cost');
        
        let ingredients = [];

        // --- Helper Functions ---
        function showMessage(msg, isError = false) {
            messageBox.textContent = msg;
            messageBox.classList.remove('bg-green-600', 'bg-red-600', 'hidden');
            if (isError) {
                messageBox.classList.add('bg-red-600');
            } else {
                messageBox.classList.add('bg-green-600');
            }
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        // --- Data Loading and Real-time Updates ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
            } else {
                await signInAnonymously(auth);
                userId = auth.currentUser.uid;
            }
            userIdDisplay.textContent = `ID Utente: ${userId}`;
            loadData();
        });

        async function loadData() {
            try {
                // Subscribe to real-time updates for ingredients
                const ingredientsQuery = collection(db, 'artifacts', appId, 'users', userId, 'ingredients');
                onSnapshot(ingredientsQuery, (snapshot) => {
                    ingredients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderIngredients();
                }, (error) => {
                    console.error("Errore nel caricamento degli ingredienti:", error);
                    showMessage("Errore nel caricamento degli ingredienti.", true);
                });

                // Subscribe to real-time updates for recipes
                const recipesQuery = collection(db, 'artifacts', appId, 'users', userId, 'recipes');
                onSnapshot(recipesQuery, (snapshot) => {
                    const recipes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderRecipes(recipes);
                }, (error) => {
                    console.error("Errore nel caricamento delle ricette:", error);
                    showMessage("Errore nel caricamento delle ricette.", true);
                });

            } catch (error) {
                console.error("Errore nel caricamento dei dati:", error);
                showMessage("Errore nel caricamento dei dati.", true);
            }
        }

        // --- Render Functions ---
        function renderIngredients() {
            ingredientsList.innerHTML = '';
            // Get all ingredient select dropdowns in the recipe form
            const selectIngredients = document.querySelectorAll('.ingredient-select');
            
            ingredients.forEach(ingredient => {
                const li = document.createElement('div');
                li.className = "flex items-center justify-between p-4 bg-white rounded-lg shadow-sm border border-gray-200 transition-transform transform hover:scale-[1.01] duration-200";
                li.innerHTML = `
                    <div>
                        <span class="font-semibold text-gray-800 text-lg">${ingredient.name}</span>
                        <span class="block text-gray-500 text-sm">Costo: €${ingredient.cost.toFixed(2)} per ${ingredient.unit}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button class="text-blue-500 hover:text-blue-700 transition duration-200 edit-ingredient-btn" data-id="${ingredient.id}">
                            <i class="fas fa-edit text-xl"></i>
                        </button>
                        <button class="text-red-500 hover:text-red-700 transition duration-200 delete-ingredient-btn" data-id="${ingredient.id}">
                            <i class="fas fa-trash-alt text-xl"></i>
                        </button>
                    </div>
                `;
                ingredientsList.appendChild(li);

                // Update all select dropdowns for recipes
                selectIngredients.forEach(select => {
                    const option = document.createElement('option');
                    option.value = ingredient.id;
                    option.textContent = ingredient.name;
                    // Check if option already exists to avoid duplicates
                    if (!select.querySelector(`option[value="${ingredient.id}"]`)) {
                        select.appendChild(option);
                    }
                });
            });

            // Add new ingredient button
            let addIngredientBtn = ingredientsForm.querySelector('#add-ingredient-btn');
            if (!addIngredientBtn) {
                addIngredientBtn = document.createElement('button');
                addIngredientBtn.id = 'add-ingredient-btn';
                addIngredientBtn.type = 'submit';
                addIngredientBtn.className = "bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-200 shadow-md flex items-center justify-center";
                addIngredientBtn.innerHTML = '<i class="fas fa-plus mr-2"></i> Aggiungi Ingrediente';
                ingredientsForm.appendChild(addIngredientBtn);
            }
            
            attachIngredientEventListeners();
            updateRecipeCost();
        }

        function renderRecipes(recipes) {
            recipesList.innerHTML = '';
            recipes.forEach(recipe => {
                const li = document.createElement('div');
                li.className = "p-4 bg-white rounded-lg shadow-sm border border-gray-200 transition-transform transform hover:scale-[1.01] duration-200";
                li.innerHTML = `
                    <div class="flex items-center justify-between">
                        <h3 class="font-semibold text-gray-800 text-lg">${recipe.name}</h3>
                        <button class="text-red-500 hover:text-red-700 transition duration-200 delete-recipe-btn" data-id="${recipe.id}">
                             <i class="fas fa-trash-alt text-xl"></i>
                        </button>
                    </div>
                    <div class="text-sm text-gray-600 mt-2">
                        <p>Costo totale: <span class="font-medium text-gray-900">€${recipe.cost.toFixed(2)}</span></p>
                        <p>Prezzo di vendita: <span class="font-medium text-gray-900">€${recipe.price.toFixed(2)}</span></p>
                        <p>Profitto: <span class="font-bold text-lg ${recipe.profit >= 0 ? 'text-green-600' : 'text-red-600'}">€${recipe.profit.toFixed(2)}</span></p>
                    </div>
                    <div class="text-xs text-gray-500 mt-2 border-t border-gray-200 pt-2">
                        <span class="font-semibold text-gray-700">Ingredienti:</span>
                        <ul class="list-disc list-inside ml-2 mt-1">
                            ${recipe.ingredients.map(ing => {
                                const foundIngredient = ingredients.find(i => i.id === ing.ingredientId);
                                return foundIngredient ? `<li>${foundIngredient.name} (${ing.quantity} ${foundIngredient.unit})</li>` : '';
                            }).join('')}
                        </ul>
                    </div>
                `;
                recipesList.appendChild(li);
            });

            // Re-attach event listeners for delete buttons
            document.querySelectorAll('.delete-recipe-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = e.currentTarget.dataset.id;
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'recipes', id));
                    showMessage('Ricetta eliminata con successo!', false);
                });
            });
        }

        function updateRecipeCost() {
            let totalCost = 0;
            const ingredientItems = recipesForm.querySelectorAll('.recipe-ingredient-item');
            ingredientItems.forEach(item => {
                const ingredientId = item.querySelector('.ingredient-select').value;
                const quantity = parseFloat(item.querySelector('.ingredient-quantity').value);

                if (ingredientId && quantity) {
                    const foundIngredient = ingredients.find(ing => ing.id === ingredientId);
                    if (foundIngredient) {
                        totalCost += foundIngredient.cost * quantity;
                    }
                }
            });
            currentRecipeCostDisplay.textContent = `Costo Totale: €${totalCost.toFixed(2)}`;
        }
        
        // --- Event Listeners ---
        function attachIngredientEventListeners() {
            document.querySelectorAll('.delete-ingredient-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = e.currentTarget.dataset.id;
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'ingredients', id));
                    showMessage('Ingrediente eliminato con successo!', false);
                });
            });

            document.querySelectorAll('.edit-ingredient-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    const ingredientToEdit = ingredients.find(ing => ing.id === id);
                    if (ingredientToEdit) {
                        editNameInput.value = ingredientToEdit.name;
                        editCostInput.value = ingredientToEdit.cost;
                        editUnitInput.value = ingredientToEdit.unit;
                        saveEditButton.dataset.id = id;
                        modal.classList.remove('hidden');
                    }
                });
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Add/Edit Ingredient
            ingredientsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('new-ingredient-name').value.trim();
                const cost = parseFloat(document.getElementById('new-ingredient-cost').value);
                const unit = document.getElementById('new-ingredient-unit').value.trim();

                if (!name || isNaN(cost) || !unit) {
                    showMessage('Per favore, compila tutti i campi per l\'ingrediente.', true);
                    return;
                }

                try {
                    await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'ingredients'), {
                        name,
                        cost,
                        unit
                    });
                    ingredientsForm.reset();
                    showMessage('Ingrediente aggiunto con successo!', false);
                } catch (error) {
                    console.error("Errore durante l'aggiunta dell'ingrediente:", error);
                    showMessage("Errore durante l'aggiunta dell'ingrediente.", true);
                }
            });

            // Save Edited Ingredient
            editForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = saveEditButton.dataset.id;
                const name = editNameInput.value.trim();
                const cost = parseFloat(editCostInput.value);
                const unit = editUnitInput.value.trim();

                if (!name || isNaN(cost) || !unit) {
                    showMessage('Per favore, compila tutti i campi.', true);
                    return;
                }

                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'ingredients', id), {
                        name,
                        cost,
                        unit
                    });
                    modal.classList.add('hidden');
                    showMessage('Ingrediente modificato con successo!', false);
                } catch (error) {
                    console.error("Errore durante la modifica dell'ingrediente:", error);
                    showMessage("Errore durante la modifica dell'ingrediente.", true);
                }
            });

            // Close Modal
            closeModalBtn.addEventListener('click', () => {
                modal.classList.add('hidden');
            });
            window.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                }
            });

            // Add Recipe
            recipesForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const recipeName = document.getElementById('new-recipe-name').value.trim();
                const recipePrice = parseFloat(document.getElementById('new-recipe-price').value);
                
                const recipeIngredients = [];
                let totalCost = 0;

                const ingredientItems = recipesForm.querySelectorAll('.recipe-ingredient-item');
                ingredientItems.forEach(item => {
                    const ingredientId = item.querySelector('.ingredient-select').value;
                    const quantity = parseFloat(item.querySelector('.ingredient-quantity').value);
                    if (ingredientId && quantity) {
                        const foundIngredient = ingredients.find(ing => ing.id === ingredientId);
                        if (foundIngredient) {
                            recipeIngredients.push({ ingredientId, quantity });
                            totalCost += foundIngredient.cost * quantity;
                        }
                    }
                });

                if (!recipeName || isNaN(recipePrice) || recipeIngredients.length === 0) {
                    showMessage('Per favore, compila tutti i campi della ricetta.', true);
                    return;
                }

                const profit = recipePrice - totalCost;

                try {
                    await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'recipes'), {
                        name: recipeName,
                        ingredients: recipeIngredients,
                        price: recipePrice,
                        cost: totalCost,
                        profit: profit
                    });
                    recipesForm.reset();
                    // Clear dynamically added ingredients except the first one
                    recipesForm.querySelectorAll('.recipe-ingredient-item:not(:first-of-type)').forEach(el => el.remove());
                    updateRecipeCost(); // Update the cost display
                    showMessage('Ricetta aggiunta con successo!', false);
                } catch (error) {
                    console.error("Errore durante l'aggiunta della ricetta:", error);
                    showMessage("Errore durante l'aggiunta della ricetta.", true);
                }
            });

            // Add new ingredient field to recipe form
            addRecipeIngredientButton.addEventListener('click', () => {
                const newIngredientHtml = `
                    <div class="flex flex-col sm:flex-row gap-2 items-end mt-2 recipe-ingredient-item">
                        <div class="flex-1 w-full">
                            <label class="block text-sm font-medium text-gray-700">Ingrediente</label>
                            <select class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 ingredient-select" required>
                                <option value="">Seleziona un ingrediente</option>
                                ${ingredients.map(ing => `<option value="${ing.id}">${ing.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="w-full sm:w-1/4">
                            <label class="block text-sm font-medium text-gray-700">Quantità</label>
                            <input type="number" step="0.01" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 ingredient-quantity" placeholder="Quantità" required/>
                        </div>
                        <button type="button" class="text-red-500 hover:text-red-700 transition duration-200 p-2 rounded-full remove-recipe-ingredient-btn">
                            <i class="fas fa-trash-alt text-lg"></i>
                        </button>
                    </div>
                `;
                ingredientsContainer.insertAdjacentHTML('beforeend', newIngredientHtml);
                
                const newRemoveButton = ingredientsContainer.lastElementChild.querySelector('.remove-recipe-ingredient-btn');
                newRemoveButton.addEventListener('click', (e) => {
                    e.currentTarget.closest('.recipe-ingredient-item').remove();
                    updateRecipeCost();
                });

                const newQuantityInput = ingredientsContainer.lastElementChild.querySelector('.ingredient-quantity');
                newQuantityInput.addEventListener('input', updateRecipeCost);

                const newSelectInput = ingredientsContainer.lastElementChild.querySelector('.ingredient-select');
                newSelectInput.addEventListener('change', updateRecipeCost);
            });

            // Initial sign-in call
            (async () => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase auth failed:", error);
                }
            })();
        });
    </script>
</head>
<body class="bg-gray-100 font-sans text-gray-800">
    <div class="p-4 sm:p-8 min-h-screen flex items-center justify-center">
        <div class="max-w-4xl w-full mx-auto bg-white shadow-xl rounded-2xl p-6 sm:p-10 border border-gray-200">
            <h1 class="text-4xl font-extrabold text-center text-gray-900 mb-2">
                <i class="fas fa-utensils text-blue-500 mr-3"></i> Food Cost Manager
            </h1>
            <p class="text-center text-gray-500 mb-8">
                Gestisci i tuoi ingredienti, ricette e calcola i profitti in tempo reale.
                <span id="user-id-display" class="block mt-2 text-xs text-gray-400"></span>
            </p>

            <div id="message-box" class="mb-4 p-4 rounded-lg text-sm text-white hidden transition-all duration-300 font-medium message-box"></div>

            <!-- Sezione per la gestione degli ingredienti -->
            <div class="bg-gray-50 p-6 rounded-xl mb-8 border border-gray-100 shadow-inner">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4 flex items-center">
                    <i class="fas fa-carrot text-orange-500 mr-2"></i> I tuoi ingredienti
                </h2>
                <div id="ingredients-list" class="space-y-4">
                    <!-- Ingredients will be rendered here by JavaScript -->
                </div>
                <form id="ingredients-form" class="mt-6 flex flex-col sm:flex-row gap-4">
                    <input type="text" id="new-ingredient-name" placeholder="Nome ingrediente (es. Farina)" class="flex-1 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" required />
                    <input type="number" step="0.01" id="new-ingredient-cost" placeholder="Costo per unità (€)" class="w-full sm:w-1/4 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" required />
                    <input type="text" id="new-ingredient-unit" placeholder="Unità (es. kg)" class="w-full sm:w-1/4 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" required />
                    <button type="submit" class="bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-200 shadow-md flex items-center justify-center">
                        <i class="fas fa-plus mr-2"></i> Aggiungi Ingrediente
                    </button>
                </form>
            </div>

            <!-- Sezione per la gestione delle ricette -->
            <div class="bg-gray-50 p-6 rounded-xl mb-8 border border-gray-100 shadow-inner">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4 flex items-center">
                    <i class="fas fa-book-open text-green-500 mr-2"></i> Le tue ricette
                </h2>
                <div id="recipes-list" class="space-y-4">
                    <!-- Recipes will be rendered here by JavaScript -->
                </div>
                
                <form id="recipes-form" class="mt-6 space-y-4">
                    <input type="text" id="new-recipe-name" placeholder="Nome ricetta" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" required />
                    
                    <div id="recipe-ingredients-container">
                        <div class="flex flex-col sm:flex-row gap-2 items-end recipe-ingredient-item">
                             <div class="flex-1 w-full">
                                <label class="block text-sm font-medium text-gray-700">Ingrediente</label>
                                <select class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 ingredient-select" required>
                                    <option value="">Seleziona un ingrediente</option>
                                    <!-- Options will be populated by JavaScript -->
                                </select>
                            </div>
                            <div class="w-full sm:w-1/4">
                                <label class="block text-sm font-medium text-gray-700">Quantità</label>
                                <input type="number" step="0.01" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 ingredient-quantity" placeholder="Quantità" required/>
                            </div>
                        </div>
                    </div>

                    <button type="button" id="add-recipe-ingredient-btn" class="bg-gray-300 text-gray-700 p-3 rounded-lg font-semibold hover:bg-gray-400 transition duration-200 flex items-center justify-center">
                        <i class="fas fa-plus mr-2"></i> Aggiungi Ingrediente alla Ricetta
                    </button>
                    
                    <div class="flex items-center gap-4 pt-4">
                        <input type="number" step="0.01" id="new-recipe-price" placeholder="Prezzo di vendita (€)" class="flex-1 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" required />
                        <span id="current-recipe-cost" class="font-bold text-gray-700 text-sm">Costo Totale: €0.00</span>
                        <button type="submit" class="bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition duration-200 shadow-md flex items-center justify-center">
                            <i class="fas fa-calculator mr-2"></i> Calcola e Aggiungi
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modale per la modifica degli ingredienti -->
    <div id="edit-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 shadow-xl max-w-sm w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800">Modifica Ingrediente</h3>
                <button id="close-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="edit-form">
                <div class="mb-4">
                    <label for="edit-name" class="block text-sm font-medium text-gray-700">Nome Ingrediente</label>
                    <input type="text" id="edit-name" class="mt-1 w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="edit-cost" class="block text-sm font-medium text-gray-700">Costo per unità (€)</label>
                    <input type="number" step="0.01" id="edit-cost" class="mt-1 w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mb-6">
                    <label for="edit-unit" class="block text-sm font-medium text-gray-700">Unità</label>
                    <input type="text" id="edit-unit" class="mt-1 w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <button id="save-edit-btn" type="submit" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-200">
                    Salva Modifiche
                </button>
            </form>
        </div>
    </div>
</body>
</html>
