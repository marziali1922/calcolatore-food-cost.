<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Cost Manager</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let userId;

        // --- DOM Elements ---
        const messageBox = document.getElementById('message-box');
        const ingredientsForm = document.getElementById('ingredients-form');
        const ingredientsList = document.getElementById('ingredients-list');
        const recipesForm = document.getElementById('recipes-form');
        const recipesList = document.getElementById('recipes-list');
        const addIngredientButton = document.getElementById('add-recipe-ingredient-btn');
        const newIngredientNameInput = document.getElementById('new-ingredient-name');
        const newIngredientCostInput = document.getElementById('new-ingredient-cost');
        const newIngredientUnitInput = document.getElementById('new-ingredient-unit');
        const userIdDisplay = document.getElementById('user-id-display');

        let ingredients = [];

        // --- Helper Functions ---
        function showMessage(msg, isError = false) {
            messageBox.textContent = msg;
            messageBox.classList.remove('bg-green-500', 'bg-red-500', 'hidden');
            if (isError) {
                messageBox.classList.add('bg-red-500');
            } else {
                messageBox.classList.add('bg-green-500');
            }
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        // --- Data Loading and Real-time Updates ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
            } else {
                // If no user, sign in anonymously
                await signInAnonymously(auth);
                userId = auth.currentUser.uid;
            }
            userIdDisplay.textContent = `ID Utente: ${userId}`;
            loadData();
        });

        async function loadData() {
            try {
                // Subscribe to real-time updates for ingredients
                const ingredientsQuery = collection(db, 'artifacts', appId, 'users', userId, 'ingredients');
                onSnapshot(ingredientsQuery, (snapshot) => {
                    ingredients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderIngredients();
                }, (error) => {
                    console.error("Errore nel caricamento degli ingredienti:", error);
                    showMessage("Errore nel caricamento degli ingredienti.", true);
                });

                // Subscribe to real-time updates for recipes
                const recipesQuery = collection(db, 'artifacts', appId, 'users', userId, 'recipes');
                onSnapshot(recipesQuery, (snapshot) => {
                    const recipes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderRecipes(recipes);
                }, (error) => {
                    console.error("Errore nel caricamento delle ricette:", error);
                    showMessage("Errore nel caricamento delle ricette.", true);
                });

            } catch (error) {
                console.error("Errore nel caricamento dei dati:", error);
                showMessage("Errore nel caricamento dei dati.", true);
            }
        }

        // --- Render Functions ---
        function renderIngredients() {
            ingredientsList.innerHTML = '';
            const selectIngredient = document.querySelectorAll('.ingredient-select');
            
            ingredients.forEach(ingredient => {
                // Render list item for ingredients
                const li = document.createElement('div');
                li.className = "flex items-center justify-between p-4 bg-white rounded-lg shadow-sm border border-gray-200";
                li.innerHTML = `
                    <div>
                        <span class="font-semibold text-gray-800">${ingredient.name}</span>
                        <span class="block text-gray-500 text-sm">Costo: €${ingredient.cost.toFixed(2)} per ${ingredient.unit}</span>
                    </div>
                    <button class="text-red-500 hover:text-red-700 transition duration-200 delete-ingredient-btn" data-id="${ingredient.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                `;
                ingredientsList.appendChild(li);

                // Update select dropdowns for recipes
                const option = document.createElement('option');
                option.value = ingredient.id;
                option.textContent = ingredient.name;
                selectIngredient.forEach(select => {
                    // Check if option already exists
                    if (!select.querySelector(`option[value="${ingredient.id}"]`)) {
                        select.appendChild(option.cloneNode(true));
                    }
                });
            });

            // Re-attach event listeners for delete buttons
            document.querySelectorAll('.delete-ingredient-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = e.currentTarget.dataset.id;
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'ingredients', id));
                    showMessage('Ingrediente eliminato con successo.', false);
                });
            });
        }

        function renderRecipes(recipes) {
            recipesList.innerHTML = '';
            recipes.forEach(recipe => {
                const li = document.createElement('div');
                li.className = "p-4 bg-white rounded-lg shadow-sm border border-gray-200";
                li.innerHTML = `
                    <div class="flex items-center justify-between">
                        <h3 class="font-semibold text-gray-800 text-lg">${recipe.name}</h3>
                        <button class="text-red-500 hover:text-red-700 transition duration-200 delete-recipe-btn" data-id="${recipe.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                    <div class="text-sm text-gray-600 mt-2">
                        <p>Costo totale: <span class="font-medium text-gray-900">€${recipe.cost.toFixed(2)}</span></p>
                        <p>Prezzo di vendita: <span class="font-medium text-gray-900">€${recipe.price.toFixed(2)}</span></p>
                        <p>Profitto: <span class="font-bold text-lg text-green-600">€${recipe.profit.toFixed(2)}</span></p>
                    </div>
                    <div class="text-xs text-gray-500 mt-2 border-t pt-2">
                        Ingredienti:
                        <ul class="list-disc list-inside ml-2">
                            ${recipe.ingredients.map(ing => {
                                const foundIngredient = ingredients.find(i => i.id === ing.ingredientId);
                                return foundIngredient ? `<li>${foundIngredient.name} (${ing.quantity} ${foundIngredient.unit})</li>` : '';
                            }).join('')}
                        </ul>
                    </div>
                `;
                recipesList.appendChild(li);
            });

            // Re-attach event listeners for delete buttons
            document.querySelectorAll('.delete-recipe-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = e.currentTarget.dataset.id;
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'recipes', id));
                    showMessage('Ricetta eliminata con successo.', false);
                });
            });
        }
        
        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            // Add Ingredient
            ingredientsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = newIngredientNameInput.value.trim();
                const cost = parseFloat(newIngredientCostInput.value);
                const unit = newIngredientUnitInput.value.trim();

                if (!name || isNaN(cost) || !unit) {
                    showMessage('Per favore, compila tutti i campi per l\'ingrediente.', true);
                    return;
                }

                try {
                    await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'ingredients'), {
                        name,
                        cost,
                        unit
                    });
                    newIngredientNameInput.value = '';
                    newIngredientCostInput.value = '';
                    newIngredientUnitInput.value = '';
                    showMessage('Ingrediente aggiunto con successo!', false);
                } catch (error) {
                    console.error("Errore durante l'aggiunta dell'ingrediente:", error);
                    showMessage("Errore durante l'aggiunta dell'ingrediente.", true);
                }
            });

            // Add Recipe
            recipesForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const recipeName = document.getElementById('new-recipe-name').value.trim();
                const recipePrice = parseFloat(document.getElementById('new-recipe-price').value);
                
                const recipeIngredients = [];
                let totalCost = 0;

                const ingredientItems = recipesForm.querySelectorAll('.recipe-ingredient-item');
                ingredientItems.forEach(item => {
                    const ingredientId = item.querySelector('.ingredient-select').value;
                    const quantity = parseFloat(item.querySelector('.ingredient-quantity').value);

                    if (ingredientId && quantity) {
                        const foundIngredient = ingredients.find(ing => ing.id === ingredientId);
                        if (foundIngredient) {
                            recipeIngredients.push({ ingredientId, quantity });
                            totalCost += foundIngredient.cost * quantity;
                        }
                    }
                });

                if (!recipeName || isNaN(recipePrice) || recipeIngredients.length === 0) {
                    showMessage('Per favore, compila tutti i campi della ricetta.', true);
                    return;
                }

                const profit = recipePrice - totalCost;

                try {
                    await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'recipes'), {
                        name: recipeName,
                        ingredients: recipeIngredients,
                        price: recipePrice,
                        cost: totalCost,
                        profit: profit
                    });
                    recipesForm.reset();
                    // Clear dynamically added ingredients
                    recipesForm.querySelectorAll('.recipe-ingredient-item:not(:first-of-type)').forEach(el => el.remove());
                    showMessage('Ricetta aggiunta con successo!', false);
                } catch (error) {
                    console.error("Errore durante l'aggiunta della ricetta:", error);
                    showMessage("Errore durante l'aggiunta della ricetta.", true);
                }
            });

            // Add new ingredient field to recipe form
            addIngredientButton.addEventListener('click', () => {
                const ingredientsContainer = document.getElementById('recipe-ingredients-container');
                const newIngredientHtml = `
                    <div class="flex flex-col sm:flex-row gap-2 items-end mt-2 recipe-ingredient-item">
                        <div class="flex-1 w-full">
                            <label class="block text-sm font-medium text-gray-700">Ingrediente</label>
                            <select class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 ingredient-select">
                                <option value="">Seleziona un ingrediente</option>
                                ${ingredients.map(ing => `<option value="${ing.id}">${ing.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="w-full sm:w-1/4">
                            <label class="block text-sm font-medium text-gray-700">Quantità</label>
                            <input type="number" step="0.01" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 ingredient-quantity" placeholder="Quantità" />
                        </div>
                        <button type="button" class="text-red-500 hover:text-red-700 transition duration-200 p-2 rounded-full remove-recipe-ingredient-btn">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                `;
                ingredientsContainer.insertAdjacentHTML('beforeend', newIngredientHtml);
                
                // Attach event listener to the new remove button
                const newRemoveButton = ingredientsContainer.lastElementChild.querySelector('.remove-recipe-ingredient-btn');
                newRemoveButton.addEventListener('click', (e) => {
                    e.currentTarget.closest('.recipe-ingredient-item').remove();
                });
            });

            // Initial sign-in call
            (async () => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase auth failed:", error);
                }
            })();
        });
    </script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="p-4 sm:p-8 min-h-screen">
        <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-2xl p-6 sm:p-10 border border-gray-200">
            <h1 class="text-3xl sm:text-4xl font-bold text-center text-gray-800 mb-2">Food Cost Manager</h1>
            <p class="text-center text-gray-500 mb-8">
                Gestisci i tuoi ingredienti, ricette e calcola i profitti.
                <span id="user-id-display" class="block mt-2 text-xs text-gray-400"></span>
            </p>

            <div id="message-box" class="mb-4 p-4 rounded-lg text-sm text-white hidden transition-all duration-300"></div>

            <!-- Sezione per la gestione degli ingredienti -->
            <div class="bg-gray-50 p-6 rounded-xl mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">I tuoi ingredienti</h2>
                <div id="ingredients-list" class="space-y-4">
                    <!-- Ingredients will be rendered here by JavaScript -->
                </div>
                <form id="ingredients-form" class="mt-6 flex flex-col sm:flex-row gap-4">
                    <input type="text" id="new-ingredient-name" placeholder="Nome ingrediente (es. Farina)" class="flex-1 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" required />
                    <input type="number" step="0.01" id="new-ingredient-cost" placeholder="Costo per unità (€)" class="w-full sm:w-1/4 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" required />
                    <input type="text" id="new-ingredient-unit" placeholder="Unità (es. kg)" class="w-full sm:w-1/4 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" required />
                    <button type="submit" class="bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-200 shadow-md">
                        Aggiungi Ingrediente
                    </button>
                </form>
            </div>

            <!-- Sezione per la gestione delle ricette -->
            <div class="bg-gray-50 p-6 rounded-xl mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Le tue ricette</h2>
                <div id="recipes-list" class="space-y-4">
                    <!-- Recipes will be rendered here by JavaScript -->
                </div>
                
                <form id="recipes-form" class="mt-6 space-y-4">
                    <input type="text" id="new-recipe-name" placeholder="Nome ricetta" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" required />
                    
                    <div id="recipe-ingredients-container">
                        <div class="flex flex-col sm:flex-row gap-2 items-end recipe-ingredient-item">
                             <div class="flex-1 w-full">
                                <label class="block text-sm font-medium text-gray-700">Ingrediente</label>
                                <select class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 ingredient-select" required>
                                    <option value="">Seleziona un ingrediente</option>
                                    <!-- Options will be populated by JavaScript -->
                                </select>
                            </div>
                            <div class="w-full sm:w-1/4">
                                <label class="block text-sm font-medium text-gray-700">Quantità</label>
                                <input type="number" step="0.01" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 ingredient-quantity" placeholder="Quantità" required/>
                            </div>
                        </div>
                    </div>

                    <button type="button" id="add-recipe-ingredient-btn" class="bg-gray-300 text-gray-700 p-3 rounded-lg font-semibold hover:bg-gray-400 transition duration-200">
                        Aggiungi Ingrediente alla Ricetta
                    </button>
                    
                    <div class="flex items-center gap-4 pt-4">
                        <input type="number" step="0.01" id="new-recipe-price" placeholder="Prezzo di vendita (€)" class="flex-1 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" required />
                        <button type="submit" class="bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition duration-200 shadow-md">
                            Calcola Costo e Aggiungi
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</body>
</html>
